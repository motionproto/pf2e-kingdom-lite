<!DOCTYPE html>
<html>
<head>
    <title>Test Kingdom Stats Updates</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            background: #2a2a2a;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #5e0000;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #7e0000;
        }
        .value {
            display: inline-block;
            padding: 5px 10px;
            background: #333;
            border-radius: 3px;
            margin: 0 10px;
            min-width: 50px;
            text-align: center;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: #333;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Kingdom Stats Update Test</h1>
    
    <div class="test-section">
        <h2>Test Scenario</h2>
        <p>This test verifies that when you edit values in KingdomStats component:</p>
        <ol>
            <li>The store update methods are called (setResource, updateKingdomStat)</li>
            <li>A new state object is created (triggering subscriptions)</li>
            <li>The UI updates immediately with the new value</li>
            <li>The change is persisted after 500ms debounce</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Interactive Test</h2>
        <p>To test in your actual Foundry module:</p>
        <ol>
            <li>Open the Kingdom Management interface</li>
            <li>Click on any editable value (Gold, Unrest, Food)</li>
            <li>Enter a new value and press Enter</li>
            <li>Verify the value updates immediately in the UI</li>
            <li>Check browser console for persistence logs after 500ms</li>
            <li>Reload the page - the value should persist</li>
        </ol>
        
        <h3>Expected Console Output:</h3>
        <pre style="background: #1a1a1a; padding: 10px; border-radius: 3px;">
[Store Update] Setting resource 'gold' to 150
[State Change] New state created with updated resources
[UI Update] Component re-rendered with new value
[Persistence] Saving state... (after 500ms)
[Persistence] State saved to Foundry settings
        </pre>
    </div>

    <div class="test-section">
        <h2>Simulated Store Updates</h2>
        <p>This simulates what happens when you edit values:</p>
        
        <div style="margin: 20px 0;">
            <strong>Gold:</strong> 
            <span class="value" id="gold">100</span>
            <button onclick="updateGold(50)">Set to 50</button>
            <button onclick="updateGold(150)">Set to 150</button>
            <button onclick="updateGold(500)">Set to 500</button>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>Unrest:</strong>
            <span class="value" id="unrest">0</span>
            <button onclick="updateUnrest(2)">Set to 2</button>
            <button onclick="updateUnrest(5)">Set to 5</button>
            <button onclick="updateUnrest(10)">Set to 10</button>
        </div>
        
        <div style="margin: 20px 0;">
            <strong>Food:</strong>
            <span class="value" id="food">20</span>
            <button onclick="updateFood(10)">Set to 10</button>
            <button onclick="updateFood(30)">Set to 30</button>
            <button onclick="updateFood(50)">Set to 50</button>
        </div>
        
        <div class="log" id="log">
            <div class="log-entry">Ready to test updates...</div>
        </div>
    </div>

    <script>
        let saveTimeout = null;
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `[${time}] ${message}`;
            entry.style.borderLeft = type === 'success' ? '3px solid #4CAF50' : 
                                     type === 'persist' ? '3px solid #2196F3' : 
                                     '3px solid #888';
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function simulatePersistence() {
            // Clear any existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
                addLog('⏱️ Debounce timer reset (500ms)');
            }
            
            // Set new timeout
            saveTimeout = setTimeout(() => {
                addLog('💾 Persistence: Saving state to Foundry settings...', 'persist');
                setTimeout(() => {
                    addLog('✅ State saved successfully!', 'success');
                }, 100);
            }, 500);
        }
        
        function updateGold(value) {
            const element = document.getElementById('gold');
            const oldValue = element.textContent;
            
            addLog(`📝 Calling setResource('gold', ${value})`);
            addLog(`🔄 Store: Creating new state object...`);
            
            // Simulate immediate UI update
            element.textContent = value;
            element.style.background = '#4CAF50';
            setTimeout(() => element.style.background = '#333', 300);
            
            addLog(`✨ UI Updated: Gold ${oldValue} → ${value}`, 'success');
            simulatePersistence();
        }
        
        function updateUnrest(value) {
            const element = document.getElementById('unrest');
            const oldValue = element.textContent;
            
            addLog(`📝 Calling updateKingdomStat('unrest', ${value})`);
            addLog(`🔄 Store: Creating new state object...`);
            
            // Simulate immediate UI update
            element.textContent = value;
            element.style.background = '#4CAF50';
            if (value > 5) element.style.color = '#ff6b6b';
            setTimeout(() => element.style.background = '#333', 300);
            
            addLog(`✨ UI Updated: Unrest ${oldValue} → ${value}`, 'success');
            simulatePersistence();
        }
        
        function updateFood(value) {
            const element = document.getElementById('food');
            const oldValue = element.textContent;
            
            addLog(`📝 Calling setResource('food', ${value})`);
            addLog(`🔄 Store: Creating new state object...`);
            
            // Simulate immediate UI update
            element.textContent = value;
            element.style.background = '#4CAF50';
            setTimeout(() => element.style.background = '#333', 300);
            
            addLog(`✨ UI Updated: Food ${oldValue} → ${value}`, 'success');
            simulatePersistence();
        }
        
        // Initial log
        addLog('🚀 Test page loaded - Click buttons to simulate store updates');
    </script>
</body>
</html>
